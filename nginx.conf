server {
    listen 80;
    listen [::]:80;

    root /var/www/html;
    index index.html;

    server_name _;
    client_max_body_size 20M;

    # Configurações de log
    error_log /var/log/nginx/error.log warn;
    access_log /var/log/nginx/access.log;

    # Headers de segurança essenciais para WebAssembly/SharedArrayBuffer
    add_header Cross-Origin-Opener-Policy same-origin always;
    add_header Cross-Origin-Embedder-Policy require-corp always;

    # Headers CORS
    add_header Access-Control-Allow-Origin '*' always;
    add_header Access-Control-Allow-Methods 'GET, POST, OPTIONS' always;
    add_header Access-Control-Allow-Headers '*' always;

    # Tratamento especial para requisições OPTIONS (preflight CORS)
    if ($request_method = 'OPTIONS') {
        add_header Access-Control-Allow-Origin '*';
        add_header Access-Control-Allow-Methods 'GET, POST, OPTIONS';
        add_header Access-Control-Allow-Headers '*';
        add_header Access-Control-Max-Age 1728000;
        add_header Content-Type 'text/plain charset=UTF-8';
        add_header Content-Length 0;
        return 204;
    }

    # Configurações para arquivos WebAssembly
    location ~* \.wasm$ {
        add_header Cross-Origin-Opener-Policy same-origin always;
        add_header Cross-Origin-Embedder-Policy require-corp always;
        add_header Access-Control-Allow-Origin '*' always;
        add_header Cache-Control 'no-store, must-revalidate' always;
        types { application/wasm wasm; }
        default_type application/wasm;
    }

    # Configurações para arquivos Godot PCK
    location ~* \.pck$ {
        add_header Cross-Origin-Opener-Policy same-origin always;
        add_header Cross-Origin-Embedder-Policy require-corp always;
        add_header Access-Control-Allow-Origin '*' always;
        add_header Cache-Control 'no-store, must-revalidate' always;
        default_type application/octet-stream;
    }

    # Configurações para arquivos JavaScript
    location ~* \.js$ {
        add_header Cross-Origin-Opener-Policy same-origin always;
        add_header Cross-Origin-Embedder-Policy require-corp always;
        add_header Access-Control-Allow-Origin '*' always;
        add_header Cache-Control 'no-store, must-revalidate' always;
        types { application/javascript js; }
        default_type application/javascript;
    }

    # Regra para index.html - garantir headers corretos
    location = /index.html {
        add_header Cross-Origin-Opener-Policy same-origin always;
        add_header Cross-Origin-Embedder-Policy require-corp always;
        add_header Access-Control-Allow-Origin '*' always;
        add_header Cache-Control 'no-store, must-revalidate' always;
        types { text/html html; }
    }

    # Tratamento padrão para outros arquivos
    location / {
        try_files $uri $uri/ /index.html;
        add_header Cross-Origin-Opener-Policy same-origin always;
        add_header Cross-Origin-Embedder-Policy require-corp always;
    }
} 